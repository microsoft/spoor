# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

steps:
- script: |
    sudo xcode-select --switch /Applications/Xcode_13.0.app
    ln -sfn /Applications/Xcode_13.0.app /Applications/Xcode.app
  displayName: Set Xcode version
  condition: eq(variables['Agent.OS'], 'Darwin')
- script: |
    wget https://apt.llvm.org/llvm.sh
    chmod +x llvm.sh
    sudo ./llvm.sh 12
  displayName: Install LLVM (Linux)
  condition: eq(variables['Agent.OS'], 'Linux')
- script: |
    brew install llvm@12
    ln -sfn /usr/local/Cellar/llvm /usr/local/Cellar/llvm@12
    echo '##vso[task.prependpath]/usr/local/opt/llvm@12/bin'
  displayName: Install LLVM (macOS)
  condition: eq(variables['Agent.OS'], 'Darwin')
- script: pip3 install pylint yapf mkdocs-material
  displayName: Install pip dependencies
- script: cat .build/macos-ci.bazelrc .build/ci.bazelrc > .bazelrc
  displayName: Create .bazelrc (macOS)
  condition: eq(variables['Agent.OS'], 'Darwin')
- script: |
    set -x
    bazel --version
    pkgutil --pkg-info=com.apple.pkg.CLTools_Executables
    xcode-select --version
    xcode-select --print-path
    xcodebuild -version
    $(xcode-select --print-path)/Toolchains/XcodeDefault.xctoolchain/usr/bin/swift --version
    $(xcode-select --print-path)/Toolchains/XcodeDefault.xctoolchain/usr/bin/clang++ --version
    $(brew --prefix llvm)/bin/clang++ --version
    which clang++
    which swift
    which clang-tidy
    which clang-format
    ls -lhai /Applications
    ls -lhai /usr/local/opt
    ls -lhai /usr/local/Cellar
  displayName: Print environment (macOS)
  condition: eq(variables['Agent.OS'], 'Darwin')
