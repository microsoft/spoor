#!/usr/bin/env python3
# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

from shared import WRAPPED_SWIFT, DEFAULT_SWIFTC
import subprocess
import sys

DISABLE_BATCH_MODE_ARG = '-disable-batch-mode'
DRIVER_USE_FRONTEND_PATH_ARG = '-driver-use-frontend-path'
ENABLE_BATCH_MODE_ARG = '-enable-batch-mode'
WHOLE_MODULE_OPTIMIZATION_ARG = '-whole-module-optimization'

def main():
    args = sys.argv[1:]
    # Swift compilation modes:
    # https://github.com/apple/swift/blob/main/docs/CompilerPerformance.md
    for mode in [ENABLE_BATCH_MODE_ARG, WHOLE_MODULE_OPTIMIZATION_ARG]:
        args = [DISABLE_BATCH_MODE_ARG if arg == mode else arg for arg in args]
    if DISABLE_BATCH_MODE_ARG not in args:
        args.append(DISABLE_BATCH_MODE_ARG)

    swiftc_args = [DEFAULT_SWIFTC]
    swiftc_args += [DRIVER_USE_FRONTEND_PATH_ARG, WRAPPED_SWIFT]
    swiftc_args += args

    swiftc_process = subprocess.Popen(swiftc_args)
    swiftc_process.wait()
    sys.exit(swiftc_process.returncode)


if __name__ == '__main__':
    main()
